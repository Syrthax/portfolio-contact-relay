name: Contact Relay

on:
  repository_dispatch:
    types: [contact_message]

permissions:
  issues: write

jobs:
  create-issue:
    runs-on: ubuntu-latest
    steps:
      - name: Exchange OAuth code for access token
        id: oauth
        run: |
          CODE="${{ github.event.client_payload.code }}"

          if [ -z "$CODE" ]; then
            echo "❌ No OAuth code received"
            exit 1
          fi

          RESPONSE=$(curl -s -X POST https://github.com/login/oauth/access_token \
            -H "Accept: application/json" \
            -H "Content-Type: application/json" \
            -d "{
              \"client_id\": \"${{ secrets.OAUTH_CLIENT_ID }}\",
              \"client_secret\": \"${{ secrets.OAUTH_CLIENT_SECRET }}\",
              \"code\": \"${CODE}\"
            }")

          TOKEN=$(echo "$RESPONSE" | jq -r '.access_token // empty')

          if [ -z "$TOKEN" ]; then
            echo "❌ Token exchange failed"
            echo "Response: $RESPONSE"
            exit 1
          fi

          echo "::add-mask::$TOKEN"
          echo "token=$TOKEN" >> "$GITHUB_OUTPUT"
          echo "✅ Token exchange successful"

      - name: Fetch GitHub username
        id: user
        run: |
          USER_RESPONSE=$(curl -s -H "Authorization: Bearer ${{ steps.oauth.outputs.token }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/user)

          USERNAME=$(echo "$USER_RESPONSE" | jq -r '.login // empty')

          if [ -z "$USERNAME" ]; then
            echo "❌ Failed to fetch user"
            echo "Response: $USER_RESPONSE"
            exit 1
          fi

          echo "username=$USERNAME" >> "$GITHUB_OUTPUT"
          echo "✅ Authenticated as @${USERNAME}"

      - name: Create contact issue
        uses: actions/github-script@v7
        with:
          script: |
            const username = '${{ steps.user.outputs.username }}';
            const senderName = `${{ github.event.client_payload.name }}` || 'Not provided';
            const message = `${{ github.event.client_payload.message }}`;

            const displayName = senderName && senderName !== ''
              ? `${senderName} (@${username})`
              : `@${username}`;

            const body = [
              '---',
              `**Name:** ${displayName}`,
              `**GitHub:** @${username}`,
              '',
              '**Message:**',
              message,
              '',
              '---',
              '_Submitted via [sarthakg.tech](https://sarthakg.tech) contact form_'
            ].join('\n');

            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Contact from @${username}`,
              body: body,
              labels: ['contact']
            });

            core.info(`✅ Issue created: ${issue.data.html_url}`);

      - name: Log result
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "✅ Contact relay complete"
          else
            echo "❌ Contact relay failed"
          fi
          fi
