name: Contact Relay

on:
  workflow_dispatch:
    inputs:
      name:
        description: "Sender name"
        required: false
        default: ""
      message:
        description: "Message content"
        required: true
      oauth_code:
        description: "OAuth authorization code"
        required: true

permissions:
  issues: write

jobs:
  relay:
    runs-on: ubuntu-latest

    steps:
      - name: Exchange OAuth code for access token
        id: auth
        env:
          OAUTH_CODE: ${{ github.event.inputs.oauth_code }}
          APP_CLIENT_ID: ${{ secrets.CLIENT_ID }}
          APP_CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
        run: |
          RESPONSE=$(curl -s -X POST \
            'https://github.com/login/oauth/access_token' \
            -H 'Accept: application/json' \
            -d "client_id=${APP_CLIENT_ID}" \
            -d "client_secret=${APP_CLIENT_SECRET}" \
            -d "code=${OAUTH_CODE}")

          TOKEN=$(echo "$RESPONSE" | jq -r '.access_token // empty')

          if [ -z "$TOKEN" ]; then
            echo "::error::OAuth code exchange failed"
            echo "$RESPONSE" | jq .
            exit 1
          fi

          echo "::add-mask::${TOKEN}"
          echo "token=${TOKEN}" >> "$GITHUB_OUTPUT"

      - name: Identify sender
        id: user
        env:
          USER_TOKEN: ${{ steps.auth.outputs.token }}
        run: |
          USERINFO=$(curl -s \
            -H "Authorization: Bearer ${USER_TOKEN}" \
            'https://api.github.com/user')

          USERNAME=$(echo "$USERINFO" | jq -r '.login // "unknown"')
          echo "username=${USERNAME}" >> "$GITHUB_OUTPUT"

      - name: Create contact issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SENDER: ${{ steps.user.outputs.username }}
          INPUT_NAME: ${{ github.event.inputs.name }}
          INPUT_MSG: ${{ github.event.inputs.message }}
        run: |
          {
            printf '### Contact Message\n\n'
            printf '**GitHub:** @%s\n' "$SENDER"
            if [ -n "$INPUT_NAME" ]; then
              printf '**Name:** %s\n' "$INPUT_NAME"
            fi
            printf '\n---\n\n'
            printf '%s\n' "$INPUT_MSG"
          } > /tmp/body.md

          TITLE=$(printf 'New Contact from %s' "$SENDER")

          gh issue create \
            --repo "${{ github.repository }}" \
            --title "$TITLE" \
            --body-file /tmp/body.md

      - name: Done
        run: echo "Contact relay complete"
